rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for authentication and authorization
    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }

    function isManager() {
      return isAuthenticated() && getUserRole() == 'manager';
    }

    function isFinance() {
      return isAuthenticated() && getUserRole() == 'finance';
    }

    function canApprove() {
      return isManager() || isFinance() || isAdmin();
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Users collection
    match /users/{userId} {
      // Anyone authenticated can read user profiles (for display names, etc.)
      allow read: if isAuthenticated();

      // Users can update their own profile (except role field)
      allow update: if isOwner(userId) &&
        (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']));

      // Allow student workers to self-register (create their own user document)
      // They can only create a document with their own uid and only as studentWorker role
      allow create: if isAuthenticated() &&
        request.auth.uid == userId &&
        request.resource.data.role == 'studentWorker';

      // Only admins can create other users and change roles
      allow create: if isAdmin();
      allow delete: if isAdmin();
      allow update: if isAdmin();
    }

    // Reports collection
    match /reports/{reportId} {
      // All authenticated users can read reports
      // (UI will filter based on role)
      allow read: if isAuthenticated();

      // Any authenticated user can create reports
      // Must set themselves as custodian
      allow create: if isAuthenticated() &&
        request.resource.data.custodianId == request.auth.uid;

      // Custodian can update their own draft reports
      // Approvers can update any report
      allow update: if isAuthenticated() && (
        (resource.data.custodianId == request.auth.uid && resource.data.status == 'draft') ||
        canApprove()
      );

      // Only admin can delete reports
      allow delete: if isAdmin();
    }

    // Project Reports collection
    match /project_reports/{projectId} {
      // All authenticated users can read project reports
      // (UI will filter based on role)
      allow read: if isAuthenticated();

      // Any authenticated user can create project reports
      // Must set themselves as custodian
      allow create: if isAuthenticated() &&
        request.resource.data.custodianId == request.auth.uid;

      // Custodian can update their own draft project reports
      // Approvers can update any project report
      allow update: if isAuthenticated() && (
        (resource.data.custodianId == request.auth.uid && resource.data.status == 'draft') ||
        canApprove()
      );

      // Only admin can delete project reports
      allow delete: if isAdmin();
    }

    // Transactions collection
    match /transactions/{transactionId} {
      // All authenticated users can read transactions
      allow read: if isAuthenticated();

      // Any authenticated user can create transactions
      // Must set themselves as requestor
      allow create: if isAuthenticated() &&
        request.resource.data.requestorId == request.auth.uid;

      // Requestor can update draft transactions
      // Approvers can update status and approval-related fields
      allow update: if isAuthenticated() && (
        (resource.data.requestorId == request.auth.uid && resource.data.status == 'draft') ||
        canApprove()
      );

      // Only admin can delete transactions
      allow delete: if isAdmin();
    }

    // Settings collection
    match /settings/{settingId} {
      // All authenticated users can read settings
      allow read: if isAuthenticated();

      // Only admins can update settings
      allow create, update: if canApprove();

      // Only admins can delete settings
      allow delete: if isAdmin();
    }

    // Student profiles collection
    match /student_profiles/{userId} {
      // Students can read their own profile, admins can read all
      allow read: if isAuthenticated() && (isOwner(userId) || isAdmin());

      // Students can create their own profile during onboarding
      allow create: if isAuthenticated() && request.auth.uid == userId;

      // Students can update their own profile, admins can update any
      allow update: if isAuthenticated() && (isOwner(userId) || isAdmin());

      // Only admins can delete profiles
      allow delete: if isAdmin();
    }

    // Student timesheets collection
    match /student_timesheets/{timesheetId} {
      // Students can read their own timesheets, admins can read all
      allow read: if isAuthenticated();

      // Students can create their own timesheets
      allow create: if isAuthenticated();

      // Students can update their own timesheets (draft status), admins can update any
      allow update: if isAuthenticated();

      // Students can delete their own timesheets, admins can delete any
      allow delete: if isAuthenticated() && (
        resource.data.studentId == request.auth.uid || isAdmin()
      );
    }

    // Student monthly reports collection
    match /student_monthly_reports/{reportId} {
      // Students can read their own reports, admins can read all
      allow read: if isAuthenticated();

      // Students can create their own monthly reports
      allow create: if isAuthenticated();

      // Students can update their own draft reports, admins can update any
      allow update: if isAuthenticated();

      // Students can delete their own reports, admins can delete any
      allow delete: if isAuthenticated() && (
        resource.data.studentId == request.auth.uid || isAdmin()
      );
    }

    // Traveling Reports Collection
    match /traveling_reports/{reportId} {
      // Anyone authenticated can read
      allow read: if isAuthenticated();

      // Users can create their own reports
      allow create: if isAuthenticated()
        && request.resource.data.reporterId == request.auth.uid;

      // Users can update their own draft reports
      // Owner can submit their own report
      // Admin can approve/reject/revert submitted reports
      allow update: if isAuthenticated() && (
        // Owner can update draft reports
        (resource.data.reporterId == request.auth.uid
         && resource.data.status == 'draft')
        // Or owner can submit their own report
        || (resource.data.reporterId == request.auth.uid
            && resource.data.status == 'draft'
            && request.resource.data.status == 'submitted')
        // Or admin can approve/reject/revert reports
        || (isAdmin()
            && resource.data.status in ['submitted', 'approved', 'rejected']
            && request.resource.data.status in ['approved', 'rejected', 'draft'])
      );

      // Users can delete their own draft reports, admin can delete any
      allow delete: if isAuthenticated() && (
        (resource.data.reporterId == request.auth.uid
          && resource.data.status == 'draft')
        || isAdmin()
      );
    }

    // Traveling Per Diem Entries Collection
    match /traveling_per_diem_entries/{entryId} {
      // Anyone authenticated can read
      allow read: if isAuthenticated();

      // Users can create entries for their own draft reports
      allow create: if isAuthenticated()
        && exists(/databases/$(database)/documents/traveling_reports/$(request.resource.data.reportId))
        && get(/databases/$(database)/documents/traveling_reports/$(request.resource.data.reportId)).data.reporterId == request.auth.uid
        && get(/databases/$(database)/documents/traveling_reports/$(request.resource.data.reportId)).data.status == 'draft';

      // Users can update entries for their own draft reports
      allow update: if isAuthenticated()
        && exists(/databases/$(database)/documents/traveling_reports/$(resource.data.reportId))
        && get(/databases/$(database)/documents/traveling_reports/$(resource.data.reportId)).data.reporterId == request.auth.uid
        && get(/databases/$(database)/documents/traveling_reports/$(resource.data.reportId)).data.status == 'draft';

      // Users can delete entries from their own draft reports
      allow delete: if isAuthenticated()
        && exists(/databases/$(database)/documents/traveling_reports/$(resource.data.reportId))
        && get(/databases/$(database)/documents/traveling_reports/$(resource.data.reportId)).data.reporterId == request.auth.uid
        && get(/databases/$(database)/documents/traveling_reports/$(resource.data.reportId)).data.status == 'draft';
    }

    // Income Reports collection
    match /income_reports/{reportId} {
      // Report owners and approvers can read; admins/managers/finance need list access
      allow read: if isAuthenticated() && (
        isOwner(resource.data.createdById) || canApprove()
      );

      // Authenticated user creates their own report
      allow create: if isAuthenticated()
        && request.resource.data.createdById == request.auth.uid;

      // Owner can edit while draft or submit; approvers can transition submitted reports
      allow update: if isAuthenticated() && (
        (
          resource.data.createdById == request.auth.uid
          && resource.data.status == 'draft'
        ) || (
          canApprove()
          && resource.data.status in ['submitted', 'underReview']
        )
      );

      // Owner can delete draft; admins can delete any
      allow delete: if isAuthenticated() && (
        (resource.data.createdById == request.auth.uid
          && resource.data.status == 'draft') || isAdmin()
      );
    }

    // Income Entries collection
    match /income_entries/{entryId} {
      // All authenticated users can read entries
      // (filtering is done at the application level based on report access)
      allow read: if isAuthenticated();

      // Create only if user owns the parent report and it is draft
      allow create: if isAuthenticated()
        && exists(/databases/$(database)/documents/income_reports/$(request.resource.data.reportId))
        && get(/databases/$(database)/documents/income_reports/$(request.resource.data.reportId)).data.createdById == request.auth.uid
        && get(/databases/$(database)/documents/income_reports/$(request.resource.data.reportId)).data.status == 'draft';

      // Update only if user owns the parent report and it is draft
      allow update: if isAuthenticated()
        && exists(/databases/$(database)/documents/income_reports/$(resource.data.reportId))
        && get(/databases/$(database)/documents/income_reports/$(resource.data.reportId)).data.createdById == request.auth.uid
        && get(/databases/$(database)/documents/income_reports/$(resource.data.reportId)).data.status == 'draft';

      // Delete only if user owns the parent report and it is draft
      allow delete: if isAuthenticated()
        && exists(/databases/$(database)/documents/income_reports/$(resource.data.reportId))
        && get(/databases/$(database)/documents/income_reports/$(resource.data.reportId)).data.createdById == request.auth.uid
        && get(/databases/$(database)/documents/income_reports/$(resource.data.reportId)).data.status == 'draft';
    }

    // Purchase Requisitions collection
    match /purchase_requisitions/{requisitionId} {
      // All authenticated users can read
      allow read: if isAuthenticated();

      // Any authenticated user can create requisitions
      allow create: if isAuthenticated();

      // Users can update draft requisitions, approvers can update submitted requisitions
      allow update: if isAuthenticated() && (
        resource.data.status == 'draft' ||
        canApprove()
      );

      // Users can delete draft requisitions, admin can delete any
      allow delete: if isAuthenticated() && (
        resource.data.status == 'draft' || isAdmin()
      );
    }

    // Purchase Requisition Items collection
    match /purchase_requisition_items/{itemId} {
      // All authenticated users can read
      allow read: if isAuthenticated();

      // Create only if the parent requisition is draft
      allow create: if isAuthenticated()
        && exists(/databases/$(database)/documents/purchase_requisitions/$(request.resource.data.requisitionId))
        && get(/databases/$(database)/documents/purchase_requisitions/$(request.resource.data.requisitionId)).data.status == 'draft';

      // Update only if the parent requisition is draft
      allow update: if isAuthenticated()
        && exists(/databases/$(database)/documents/purchase_requisitions/$(resource.data.requisitionId))
        && get(/databases/$(database)/documents/purchase_requisitions/$(resource.data.requisitionId)).data.status == 'draft';

      // Delete only if the parent requisition is draft
      allow delete: if isAuthenticated()
        && exists(/databases/$(database)/documents/purchase_requisitions/$(resource.data.requisitionId))
        && get(/databases/$(database)/documents/purchase_requisitions/$(resource.data.requisitionId)).data.status == 'draft';
    }
  }
}
